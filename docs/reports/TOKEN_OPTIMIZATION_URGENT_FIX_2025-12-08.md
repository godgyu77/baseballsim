# 토큰 사용량 긴급 최적화 - 추가 개선사항

**일자**: 2025-12-08  
**현재 상태**: 평균 181,762 토큰/요청 (여전히 매우 높음)  
**압축률**: N/A (압축이 제대로 작동하지 않음)

---

## 🚨 현재 문제점

### 1. **압축률이 N/A로 표시되는 이유**
- 압축 전/후 길이 추적이 제대로 되지 않음
- `compressedHistoryLength`가 `originalHistoryLength`와 동일하게 설정됨
- 실제 압축 효과를 측정할 수 없음

### 2. **여전히 높은 토큰 사용량**
- 평균 181,762 토큰은 여전히 매우 높음
- 히스토리 압축이 적용되었지만 효과가 제한적
- System Logic이 매번 전송되고 있을 가능성

---

## ✅ 방금 적용한 추가 최적화

### 1. **히스토리 크기 추가 축소**
- `MAX_HISTORY_TURNS`: 6 → **3** (약 50% 추가 절감)
- 최근 3개 턴만 유지

### 2. **메시지 길이 제한 강화**
- `MAX_MESSAGE_LENGTH`: 5,000 → **3,000자** (40% 추가 절감)
- `MAX_USER_INPUT_LENGTH`: 5,000 → **3,000자** (40% 추가 절감)

### 3. **압축 함수 개선**
- `compressHistory`에 메시지 길이 제한 로직 통합
- 각 메시지에 자동으로 3,000자 제한 적용
- STATUS, OPTIONS 태그는 보존

### 4. **압축률 추적 개선**
- 압축 전 원본 히스토리 저장
- 문자 수 기준으로 압축률 계산
- 모니터링 대시보드에 정확한 압축률 표시

---

## 📊 예상 효과

### 최적화 전 (현재)
- 히스토리: 6개 턴 × 평균 5,000 토큰 = 30,000 토큰
- System Logic: 약 50,000 토큰
- 사용자 입력: 평균 1,000 토큰
- **총합: 약 81,000 토큰/요청**

### 최적화 후 (예상)
- 히스토리: 3개 턴 × 평균 1,500 토큰 (길이 제한) = **4,500 토큰** (85% 절감)
- System Logic: 약 50,000 토큰 (변화 없음)
- 사용자 입력: 평균 500 토큰 (50% 절감)
- **총합: 약 55,000 토큰/요청** (32% 절감)

### 추가 개선 필요
- System Logic 최적화 필요 (약 50,000 토큰이 가장 큰 문제)
- Context Caching 활성화 또는 경량 버전 사용

---

## 🔧 추가 개선 방안

### 1. **System Logic 경량 버전 생성** (최우선)
```typescript
// 핵심 규칙만 포함하는 경량 버전
const KBO_SYSTEM_LOGIC_LITE = `
# 핵심 규칙 (전체 규칙은 별도 참조)
- 난이도별 설정 준수
- 데이터 무결성 유지
- 현실성 보장
... (핵심만 추출, 약 1/10 크기)
`;
```

### 2. **히스토리 요약 강화**
- 오래된 메시지는 완전히 요약 (핵심 정보만)
- 최근 2개 턴만 전체 유지

### 3. **메시지 길이 제한 더 강화**
- 각 메시지당 2,000자로 추가 축소
- STATUS 태그만 추출하여 유지

---

## ⚠️ 주의사항

1. **게임 맥락 유지**: 히스토리를 너무 줄이면 게임 맥락이 사라질 수 있음
2. **중요 정보 보존**: STATUS, OPTIONS 태그는 반드시 유지
3. **점진적 적용**: 한 번에 너무 많이 줄이지 말고 단계적으로 적용

---

## 📝 다음 단계

1. **즉시 확인**: 새로고침 후 토큰 사용량 확인
2. **압축률 확인**: 모니터링 대시보드에서 압축률이 표시되는지 확인
3. **추가 최적화**: System Logic 경량 버전 생성 고려
