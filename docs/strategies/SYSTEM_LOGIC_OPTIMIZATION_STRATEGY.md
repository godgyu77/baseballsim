# System Logic 경량화 전략

**일자**: 2025-12-09  
**목적**: System Logic 토큰 사용량 116,563 → 30,000 이하로 감소 (규칙 100% 보존)

---

## 📊 현재 상황

### SystemLogic.ts 분석 결과

- **파일 크기**: 약 181,522자 (약 116,563 토큰)
- **정적 데이터**: 이미 `InitialData.ts`로 분리됨 ✅
- **문제점**: 
  - 상세한 규칙 설명과 반복 지시사항
  - 중복된 경고 메시지
  - 예시와 설명이 과도함

### 핵심 규칙 보존 필수 항목

다음 항목들은 **절대 삭제하거나 요약하면 안 됩니다**:

1. **20-80 스케일 능력치 규칙**
2. **부상 확률 계산 공식**
3. **재정 페널티 규칙**
4. **샐러리캡 계산 로직**
5. **보호선수 자동 산정 프로세스**
6. **FA 연봉 산정 공식**
7. **난이도별 차별화 원칙**
8. **데이터 무결성 검증 규칙**

---

## 🎯 경량화 전략

### 1. 반복 지시사항 통합

**Before (반복)**:
```
[절대 원칙]: InitialData에 명시된 선수만 사용
[절대 금지]: InitialData에 없는 선수 추가 금지
[검증 필수]: 로스터 출력 전 InitialData 확인
```

**After (통합)**:
```
[CRITICAL] InitialData 무결성 규칙:
- 사용: InitialData에 명시된 선수만 사용
- 금지: 없는 선수 추가, 정보 변경
- 검증: 로스터 출력 전 반드시 확인
```

### 2. 예시 간소화

**Before (상세 예시)**:
```
예시: "Initial Data"에 "김도영 (31)"로 되어 있다면, 나이를 29로 변경하거나 포지션을 변경하면 안 됩니다.
예시: "Initial Data"에 "김서현 (22) 마무리"로 되어 있다면, 포지션을 불펜으로 변경하면 안 됩니다.
예시: "Initial Data"에 "박상원 (32) 셋업"으로 되어 있다면, 포지션을 마무리로 변경하면 안 됩니다.
```

**After (간소화)**:
```
예시: InitialData의 선수 정보(이름, 나이, 포지션, 스탯)는 절대 변경 금지
```

### 3. 중복 경고 제거

**Before (중복)**:
```
[🛑 CRITICAL] 초기 로스터 출력 시 절대 준수 사항:
* [절대 원칙]: ...
* [절대 금지]: ...
* [검증 필수]: ...

[🛑 CRITICAL] 초기 로스터 출력 시 절대 준수 사항:
* [절대 원칙]: ... (동일 내용 반복)
```

**After (통합)**:
```
[🛑 CRITICAL] 로스터 무결성 규칙 (모든 로스터 출력 시 적용):
* [절대 원칙]: ...
* [절대 금지]: ...
* [검증 필수]: ...
```

### 4. 설명 간소화

**Before (상세 설명)**:
```
당신은 'KBO 프로야구 단장 웹 시뮬레이터'의 게임 엔진 및 진행자입니다. 사용자는 한 구단의 '단장'이 되어 구단을 운영하며, 당신은 나머지 9개(또는 10개, 신생 구단 창단 시) 구단의 운영, 경기 시뮬레이션, 일정, 재정, 이벤트를 처리합니다.

당신의 목표는 **사용자가 선택한 '난이도'에 맞춰 최적의 경험을 제공하는 것**입니다.
- **이지 모드:** 사용자가 야구단 운영의 재미와 승리의 기쁨을 만끽할 수 있도록 돕는 조력자입니다.
- **노말 모드:** 현실 야구와 동일한 밸런스를 유지하며, 공정하고 객관적인 결과를 출력하는 냉철한 중재자입니다.
- **하드 모드:** 사용자에게 도전적인 환경을 제공하지만, 완전히 절망적이지 않은 합리적인 경영 환경을 만드는 엄격한 감독관입니다.
- **헬 모드:** 사용자를 극한의 상황으로 몰아넣고 시련을 주는, 가혹하지만 합리적인 비즈니스맨입니다.
```

**After (간소화)**:
```
역할: KBO 프로야구 단장 웹 시뮬레이터 게임 엔진
- 사용자: 한 구단 단장
- AI: 나머지 구단 운영, 시뮬레이션, 재정, 이벤트 처리
- 목표: 선택한 난이도에 맞춘 최적 경험 제공
```

---

## 📋 구현 계획

### Phase 1: 반복 제거 (예상 절감: 30%)

1. 중복된 경고 메시지 통합
2. 반복된 지시사항 통합
3. 예시 간소화

**예상 결과**: 116,563 토큰 → 81,594 토큰

### Phase 2: 설명 간소화 (예상 절감: 40%)

1. 상세 설명을 핵심만 남기기
2. 불필요한 예시 제거
3. 문장 간소화

**예상 결과**: 81,594 토큰 → 48,956 토큰

### Phase 3: 구조 최적화 (예상 절감: 20%)

1. 섹션 구조 재정리
2. 관련 규칙 그룹화
3. 참조 구조 개선

**예상 결과**: 48,956 토큰 → 39,165 토큰

### 최종 목표: 30,000 토큰 이하

---

## ✅ 보존 필수 항목 체크리스트

- [x] 20-80 스케일 능력치 규칙
- [x] 부상 확률 계산 공식
- [x] 재정 페널티 규칙
- [x] 샐러리캡 계산 로직
- [x] 보호선수 자동 산정 프로세스
- [x] FA 연봉 산정 공식
- [x] 난이도별 차별화 원칙
- [x] 데이터 무결성 검증 규칙
- [x] UI 태그 및 JSON 포맷 규칙
- [x] 시즌 일정 진행 원칙

---

## 🎯 동적 주입 시스템 연동

### 현재 구현

- ✅ `contextInjector.ts`: 상황별 컨텍스트 주입
- ✅ `promptService.ts`: 동적 프롬프트 생성

### 사용 예시

```typescript
// 초기화 시
const prompt = composeDynamicPrompt({
  isInitialization: true,
  userMessage: '게임 시작',
  gamePhase: 'TEAM_SELECTION',
});

// FA 협상 시
const prompt = composeDynamicPrompt({
  isInitialization: false,
  userMessage: '김도영과 FA 협상',
  gamePhase: 'NEGOTIATION',
  targetPlayer: { name: '김도영', ... },
  teamBudget: 25.5,
});
```

---

## 📊 예상 효과

### Before (현재)

| 항목 | 토큰 |
|------|------|
| System Logic | 116,563 |
| InitialData (매번?) | 50,000? |
| 히스토리 | 10,000 |
| 사용자 입력 | 1,000 |
| **총합** | **177,563+** |

### After (경량화 + 동적 주입)

| 항목 | 토큰 |
|------|------|
| System Logic (경량화) | 30,000 |
| InitialData | 0 (초기화 시에만) |
| 동적 컨텍스트 | 500-2,000 |
| 히스토리 | 10,000 |
| 사용자 입력 | 1,000 |
| **총합** | **약 41,500-43,000** |

**절감률**: 약 75% 감소

---

## 🚀 다음 단계

1. **SystemLogic.ts 경량화 작업 시작**
2. **핵심 규칙 보존 검증**
3. **동적 주입 시스템 테스트**
4. **토큰 사용량 모니터링**
